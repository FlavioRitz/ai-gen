{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Chatbot Interface</h1>
    <div id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        {% for message in chat_history %}
            {% if message.role != 'system' %}
                <p><strong>{{ message.role|capitalize }}:</strong> {{ message.content }}</p>
            {% endif %}
        {% endfor %}
    </div>

    <div id="progress-bar" class="progress mb-3" style="display: none;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
    </div>

    <form id="chat-form" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="pdf-upload" class="form-label">Upload PDF (optional)</label>
            <input type="file" class="form-control" id="pdf-upload" accept=".pdf">
        </div>
        <div class="input-group mb-3">
            <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
            <div class="input-group-append">
                <button id="send-button" class="btn btn-primary" type="submit">Send</button>
            </div>
        </div>
    </form>

    <button id="clear-chat" class="btn btn-secondary">Clear Chat History</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    function scrollToBottom() {
        var chatMessages = $('#chat-messages');
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }

    function setLoading(isLoading) {
        if (isLoading) {
            $('#progress-bar').show();
            $('#send-button').prop('disabled', true);
            $('#user-input').prop('disabled', true);
            $('#pdf-upload').prop('disabled', true);
        } else {
            $('#progress-bar').hide();
            $('#send-button').prop('disabled', false);
            $('#user-input').prop('disabled', false);
            $('#pdf-upload').prop('disabled', false);
        }
    }

    $('#chat-form').submit(function(e) {
        e.preventDefault();
        var userInput = $('#user-input').val();
        var pdfFile = $('#pdf-upload')[0].files[0];

        if (userInput.trim() === '' && !pdfFile) return;

        var formData = new FormData();
        formData.append('message', userInput);
        if (pdfFile) {
            formData.append('pdf', pdfFile);
        }

        // Append user message to chat
        $('#chat-messages').append('<p><strong>User:</strong> ' + userInput + (pdfFile ? ' (PDF uploaded)' : '') + '</p>');
        scrollToBottom();

        // Clear input fields
        $('#user-input').val('');
        $('#pdf-upload').val('');

        // Show progress bar and disable input
        setLoading(true);

        // Send message to server
        $.ajax({
            url: '/chatbot_send',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    // Append assistant message to chat
                    $('#chat-messages').append('<p><strong>Assistant:</strong> ' + response.message + '</p>');
                    scrollToBottom();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('An error occurred while sending the message.');
            },
            complete: function() {
                // Hide progress bar and enable input
                setLoading(false);
            }
        });
    });

    $('#clear-chat').click(function() {
        $.post('/clear_chat', function() {
            $('#chat-messages').empty();
        });
    });

    scrollToBottom();
});
</script>
{% endblock %}